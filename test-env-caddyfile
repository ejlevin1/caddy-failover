{
    order failover_proxy before reverse_proxy
    debug
}

:8080 {
    handle /api/* {
        # Using environment variables in upstream URLs and headers
        # Note: httpbin.org/anything endpoint echoes the request
        failover_proxy http://{env.DOCKER_HOST_URI}:3000 https://httpbin.org/anything {
            fail_duration 3s
            dial_timeout 2s
            response_timeout 5s
            insecure_skip_verify

            # Headers with environment variables
            header_up http://{env.DOCKER_HOST_URI}:3000 X-Environment {env.ENVIRONMENT}
            header_up http://{env.DOCKER_HOST_URI}:3000 X-Custom-Host {env.CUSTOM_HOST}
            header_up https://httpbin.org/anything X-Environment production
        }
    }

    handle /test/* {
        # Mixed configuration with env vars and hardcoded values
        failover_proxy http://{env.DOCKER_HOST_URI}:5041 https://httpbin.org/anything {
            fail_duration 5s
            header_up http://{env.DOCKER_HOST_URI}:5041 X-Service-Track caddy
        }
    }

    handle /health {
        respond "OK" 200
    }
}
